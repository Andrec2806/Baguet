<script>
/* ===========================================
   FIX botón "Publicar" (GitHub Pages, sin servidor)
   - IndexedDB correcta (usa oncomplete de la transacción)
   - Habilita el botón solo cuando DB está lista
   - Manejo de errores visible en #status
   - No depende de servidores ni PocketBase
   =========================================== */

(function(){
  // ----- Util -----
  const $ = (id) => document.getElementById(id);
  const statusEl = $('status');
  const btn = $('btnPublish');
  const form = $('postForm');

  // Aseguramos que exista window.pending (fotos/videos preparados)
  window.pending = Array.isArray(window.pending) ? window.pending : [];

  // ----- IndexedDB (corregida) -----
  const DB_NAME = 'baguet_local';
  const STORE   = 'posts';
  let db;

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = () => {
        const d = req.result;
        if (!d.objectStoreNames.contains(STORE)) {
          d.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
        }
      };
      req.onsuccess = () => { db = req.result; resolve(db); };
      req.onerror   = () => reject(req.error);
    });
  }

  function addPost(post){
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, 'readwrite');
      const st = tx.objectStore(STORE);
      const req = st.add(post);
      let key;
      req.onsuccess = () => { key = req.result; };
      tx.oncomplete = () => resolve(key);
      tx.onerror    = () => reject(tx.error);
      tx.onabort    = () => reject(tx.error);
    });
  }

  function getAll(){
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(STORE, 'readonly');
      const req = tx.objectStore(STORE).getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror   = () => reject(req.error);
    });
  }

  // ----- Render listado (mínimo para refrescar después de publicar) -----
  async function refreshList(currentRoom){
    const feed = $('feed');
    const countEl = $('count');
    const q = $('q');
    if (!feed) return;

    const list = await getAll();
    const esc = s => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const isVideo = m => m && m.kind === 'video';

    const term = (q?.value || '').toLowerCase().trim();
    const filtered = list
      .filter(p => (p.room || 'loja') === (currentRoom || 'loja'))
      .filter(p => !term || (p.title||'').toLowerCase().includes(term) || (p.author||'').toLowerCase().includes(term))
      .sort((a,b) => new Date(b.created) - new Date(a.created));

    feed.innerHTML = filtered.map(p => {
      const tel = (p.phone || '').replace(/[^0-9+]/g,'');
      const strip = (Array.isArray(p.media) ? p.media.map(m => {
        return isVideo(m)
          ? `<video src="${m.dataUrl}" controls playsinline style="width:160px;height:120px;object-fit:cover;border-radius:10px;border:1px solid #e1e4ea;background:#f1f3f7"></video>`
          : `<img src="${m.dataUrl}" alt="" style="width:160px;height:120px;object-fit:cover;border-radius:10px;border:1px solid #e1e4ea;background:#f1f3f7">`;
      }).join('') : '');

      return `
      <article class="card">
        ${p.cover ? `<img class="cover" src="${p.cover}" alt="${esc(p.title)}">` : ''}
        ${strip ? `<div class="strip">${strip}</div>` : ''}
        <div class="body">
          <h3 style="margin:0 0 6px">${esc(p.title)}</h3>
          <div class="muted">Por ${esc(p.author||'Anónimo')} • ${new Date(p.created).toLocaleString()}</div>
          <div class="price">$${Number(p.price||0).toFixed(2)}</div>
          ${p.description ? `<p class="muted" style="margin:6px 0 0">${esc(p.description)}</p>` : ''}
          <div class="row-actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            ${tel ? `<a class="link" target="_blank" href="https://wa.me/${tel}?text=${encodeURIComponent('Hola, me interesa: '+p.title)}">WhatsApp</a>` : ''}
            ${tel ? `<a class="link" href="tel:${tel}">Llamar</a>` : ''}
          </div>
        </div>
      </article>`;
    }).join('');

    if (countEl) countEl.textContent = filtered.length;
  }

  // ----- Ir a pestaña 'listado' si existe -----
  function goListado(){
    const viewListado = document.querySelector('[data-view="listado"]');
    const tabListado = document.querySelector('.tab[data-goto="listado"]');
    if (viewListado && tabListado){
      document.querySelectorAll('[data-view]').forEach(v=>v.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      viewListado.classList.add('active');
      tabListado.classList.add('active');
      location.hash = 'listado';
    } else {
      // fallback: desplazar al feed
      $('feed')?.scrollIntoView({behavior:'smooth'});
    }
  }

  // ----- Submit del formulario (FIX) -----
  async function onSubmit(e){
    e.preventDefault();
    if (!form || !btn) return;

    const room  = ($('room')?.value || 'loja').trim();
    const title = ($('title')?.value || '').trim();
    const price = $('price')?.value;
    const author= ($('author')?.value || 'Anónimo').trim();
    const phone = ($('phone')?.value || '').trim();
    const description = ($('description')?.value || '').trim();

    if (!title || !price || !author){
      if (statusEl) statusEl.textContent = 'Completa título, precio y tu nombre.';
      return;
    }

    const image = window.pending.find(m => m.kind === 'image'); // portada opcional
    const post = {
      room,
      title,
      price: Number(price),
      author,
      phone,
      description,
      media: [...window.pending],
      cover: image ? image.dataUrl : null,
      created: new Date().toISOString()
    };

    // UX: deshabilitar mientras guarda
    const prev = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Guardando…';
    if (statusEl) statusEl.textContent = '';

    try{
      await addPost(post);
      if (statusEl) statusEl.textContent = 'Publicado (guardado en este navegador).';
      // limpiar
      form.reset();
      window.pending = [];
      // si tienes chips, vacíalos
      const chips = $('chips'); if (chips) chips.innerHTML = '';
      // refrescar listado y saltar
      await refreshList(room);
      goListado();
    }catch(err){
      console.error(err);
      if (statusEl) statusEl.textContent = 'No se pudo guardar (IndexedDB).';
    }finally{
      btn.disabled = false;
      btn.textContent = prev;
    }
  }

  // ----- Inicio: abrir DB y activar botón -----
  async function start(){
    try{
      if (!('indexedDB' in window)) {
        alert('Tu navegador no soporta IndexedDB.');
        return;
      }
      if (btn) btn.disabled = true;
      await openDB();           // DB lista
      if (btn) btn.disabled = false;

      // Enlazar submit (una sola vez)
      if (form && !form._wired){
        form.addEventListener('submit', onSubmit);
        form._wired = true;
      }

      // Primera carga del listado para la sala actual
      const sala = ($('room')?.value || 'loja').trim();
      await refreshList(sala);

      // Búsqueda en vivo si existe input #q
      const q = $('q');
      if (q && !q._wired){
        q.addEventListener('input', ()=> refreshList(($('room')?.value || 'loja').trim()));
        q._wired = true;
      }
    }catch(e){
      console.error(e);
      if (statusEl) statusEl.textContent = 'Error inicializando la base local.';
    }
  }

  // Arranque cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start);
  } else {
    start();
  }
})();
</script>
