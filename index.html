<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Baguet ‚Äî Publicar</title>
<link rel="icon" href="logo-baguet.png">
<style>
  :root{--nav:#0e1626;--brand1:#2563eb;--brand2:#7c3aed;--border:#e7eaf1;--muted:#64748b;--radius:14px}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f6f7fb;color:#0f1720}
  .top{position:sticky;top:0;z-index:20;background:var(--nav);color:#e8f0ff;border-bottom:1px solid rgba(255,255,255,.08)}
  .topin{max-width:1100px;margin:auto;padding:10px 16px;display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}.brand img{width:36px;height:36px;border-radius:8px;background:#fff}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.25);background:transparent;color:#e8f0ff;border-radius:10px;padding:9px 12px;font-weight:700;text-decoration:none;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn:hover{border-color:#fff}.primary{border:0;background:linear-gradient(180deg,var(--brand1),var(--brand2));color:#fff}
  .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.05),0 6px 20px rgba(0,0,0,.06)}
  .body{padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}@media(max-width:820px){.row{grid-template-columns:1fr}}
  label{display:block;font-size:13px;color:#475569;margin:2px 0 6px}
  input,textarea{width:100%;padding:12px;border:1px solid #cfd5e1;border-radius:10px;font-size:14px;background:#fff}
  input:focus,textarea:focus{outline:none;border-color:#9ac5ff;box-shadow:0 0 0 3px rgba(37,99,235,.16)}
  textarea{resize:vertical;min-height:90px}
  .muted{color:var(--muted);font-size:13px}
  .files{border:1px dashed #cfd5e1;border-radius:12px;background:#fafcff;padding:12px;margin-top:12px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;border:1px solid #c9d3e5;background:#fff;font-size:12px}
  .chip button{border:0;background:transparent;color:#ef4444;cursor:pointer}
  .toast{position:fixed;right:16px;bottom:16px;background:#0e1626;color:#e8f0ff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.2);display:none}
</style>
</head>
<body>
<header class="top">
  <div class="topin">
    <a class="brand" href="listado.html"><img src="logo-baguet.png" alt=""><b style="color:#fff">BAGUET</b></a>
    <div></div>
    <div>
      <a class="btn" id="goList" href="listado.html">Listado</a>
      <a class="btn primary" href="publicar.html">Publicar</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div class="body">
      <h2 style="margin:0 0 10px">Crear publicaci√≥n</h2>
      <form id="postForm" autocomplete="off">
        <div class="row">
          <div><label>Sala</label><input id="room" type="text" placeholder="loja"></div>
          <div><label>Tu nombre</label><input id="author" type="text" required placeholder="Tu nombre"></div>
          <div><label>T√≠tulo / producto</label><input id="title" type="text" required placeholder="Ej. Pan artesanal"></div>
          <div><label>Precio (USD)</label><input id="price" type="number" step="0.01" min="0" required placeholder="1.50"></div>
          <div><label>WhatsApp</label><input id="phone" type="tel" placeholder="+593..."></div>
        </div>

        <div style="margin-top:10px">
          <label>Descripci√≥n</label>
          <textarea id="description" placeholder="Detalles, punto de entrega, etc."></textarea>
        </div>

        <div class="files">
          <label>Subir fotos y videos (m√∫ltiples)</label>
          <input id="mediaInput" type="file" accept="image/*,video/*" multiple>
          <div class="muted" style="margin-top:6px">Las fotos se optimizan; los videos se env√≠an tal cual.</div>
          <div id="chips" class="chips"></div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin-top:14px">
          <button id="btnPublish" class="btn primary" type="submit" disabled>Publicar</button>
          <span id="status" class="muted"></span>
        </div>
      </form>
    </div>
  </div>
</main>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
<script>
/* --------------------------
   CONFIG PocketBase
   -------------------------- */
// Prioridad: ?pb=‚Ä¶  -> localStorage.PB_URL -> default http://127.0.0.1:8090
const urlParamPB = new URLSearchParams(location.search).get('pb');
if (urlParamPB) localStorage.setItem('PB_URL', urlParamPB);
const PB_URL = localStorage.getItem('PB_URL') || 'http://127.0.0.1:8090';
const pb = new PocketBase(PB_URL);

/* --------------------------
   UI helpers
   -------------------------- */
const $ = id => document.getElementById(id);
const statusEl = $('status'), btn = $('btnPublish'), chips = $('chips'), mediaInput = $('mediaInput');
const toast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2500); };

const params = new URLSearchParams(location.search);
const defaultRoom = params.get('sala') || 'loja';
$('room').value = defaultRoom;
$('goList').href = 'listado.html?sala=' + encodeURIComponent(defaultRoom);

/* --------------------------
   Adjuntos m√∫ltiples (con compresi√≥n de fotos)
   -------------------------- */
let pending = []; // File[]

mediaInput.addEventListener('change', ()=>{
  const files = Array.from(mediaInput.files || []);
  files.forEach(f=>{
    if (f.type.startsWith('image/')){
      const r = new FileReader();
      r.onload = e=>{
        const img = new Image();
        img.onload = ()=>{
          const maxW=1600, q=.82, s=Math.min(1, maxW/img.width);
          const w=Math.round(img.width*s), h=Math.round(img.height*s);
          const c=document.createElement('canvas'); c.width=w; c.height=h;
          c.getContext('2d').drawImage(img,0,0,w,h);
          c.toBlob(b=>{
            pending.push(new File([b],'foto_'+Date.now()+'.jpg',{type:'image/jpeg'}));
            renderChips();
          }, 'image/jpeg', q);
        };
        img.src = e.target.result;
      };
      r.readAsDataURL(f);
    }else{
      pending.push(f);
    }
  });
  mediaInput.value = '';
  renderChips();
});

function renderChips(){
  const human=b=> b<1024? b+' B' : b<1048576? (b/1024).toFixed(1)+' KB' : (b/1048576).toFixed(1)+' MB';
  chips.innerHTML = pending.map((f,i)=>`
    <span class="chip">
      ${f.type.startsWith('image/')?'üñºÔ∏è':'üé•'} ${f.name}
      <small style="color:#64748b">(${human(f.size)})</small>
      <button type="button" data-x="${i}">‚úï</button>
    </span>`).join('');
}
chips.addEventListener('click', e=>{
  const b = e.target.closest('[data-x]'); if(!b) return;
  pending.splice(+b.dataset.x,1); renderChips();
});

/* --------------------------
   Auth invitado y habilitar bot√≥n
   -------------------------- */
async function ensureGuest(){
  const K1='pb_u', K2='pb_p';
  let u=localStorage.getItem(K1), p=localStorage.getItem(K2);
  try{ if(u && p){ await pb.collection('users').authWithPassword(u,p); return; } }catch{}
  u='guest_'+Math.random().toString(36).slice(2,10);
  p=Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);
  await pb.collection('users').create({username:u,password:p,passwordConfirm:p,name:u});
  await pb.collection('users').authWithPassword(u,p);
  localStorage.setItem(K1,u); localStorage.setItem(K2,p);
}

(async function init(){
  try{
    await ensureGuest();
    btn.disabled = false; // <- ya se puede publicar
    toast('Conectado a ' + PB_URL);
  }catch(err){
    console.error(err);
    statusEl.textContent = 'No se pudo autenticar. Revisa PB_URL.';
  }
})();

/* --------------------------
   Publicar
   -------------------------- */
$('postForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (btn.disabled) return;

  const me = pb.authStore.model;
  const room = ($('room').value||'loja').trim();
  const title = $('title').value.trim();
  const price = $('price').value;
  const author = $('author').value.trim() || (me?.username ?? 'An√≥nimo');
  const phone = $('phone').value.trim();
  const description = $('description').value.trim();

  if (!title || !price || !author){
    statusEl.textContent = 'Completa t√≠tulo, precio y tu nombre.'; return;
  }

  const fd = new FormData();
  fd.append('room', room);
  fd.append('title', title);
  fd.append('price', price);
  fd.append('author', author);
  fd.append('phone', phone);
  fd.append('description', description);
  fd.append('user', me.id);

  const firstImg = pending.find(f=>f.type.startsWith('image/'));
  if (firstImg) fd.append('image', firstImg);
  pending.forEach(f => fd.append('media', f));

  // UX: loading
  btn.disabled = true;
  const oldLabel = btn.textContent;
  btn.textContent = 'Publicando‚Ä¶';
  statusEl.textContent = '';

  try{
    await pb.collection('posts').create(fd);
    toast('Publicado ‚úì');
    // redirigir al listado de la sala
    location.href = 'listado.html?sala=' + encodeURIComponent(room);
  }catch(err){
    console.error(err);
    statusEl.textContent = 'Error al publicar (ver consola).';
    toast('Error al publicar');
    btn.disabled = false; btn.textContent = oldLabel;
  }
});
</script>
</body>
</html>
