<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Baguet ‚Äî Publicar</title>
<link rel="icon" href="logo-baguet.png" />
<style>
  :root{--nav:#0e1626;--b1:#2563eb;--b2:#7c3aed;--muted:#64748b;--border:#e7eaf1;--radius:14px}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f6f7fb;color:#0f1720}
  .top{position:sticky;top:0;z-index:20;background:var(--nav);color:#e8f0ff;border-bottom:1px solid rgba(255,255,255,.08)}
  .topin{max-width:1100px;margin:auto;padding:10px 16px;display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}.brand img{width:36px;height:36px;border-radius:8px;background:#fff}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.25);background:transparent;color:#e8f0ff;border-radius:10px;padding:9px 12px;font-weight:700;text-decoration:none;cursor:pointer}
  .btn:hover{border-color:#fff}.primary{border:0;background:linear-gradient(180deg,var(--b1),var(--b2));color:#fff}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.05),0 6px 20px rgba(0,0,0,.06)}
  .body{padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}@media(max-width:820px){.row{grid-template-columns:1fr}}
  label{display:block;font-size:13px;color:#475569;margin:2px 0 6px}
  input,textarea{width:100%;padding:12px;border:1px solid #cfd5e1;border-radius:10px;background:#fff;font-size:14px}
  input:focus,textarea:focus{outline:none;border-color:#9ac5ff;box-shadow:0 0 0 3px rgba(37,99,235,.16)}
  textarea{resize:vertical;min-height:90px}
  .muted{color:var(--muted);font-size:13px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}@media(max-width:900px){.grid2{grid-template-columns:1fr}}
  .box{border:1px dashed #cfd5e1;border-radius:12px;background:#fafcff;padding:12px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;border:1px solid #c9d3e5;background:#fff;font-size:12px}
  .chip button{border:0;background:transparent;color:#ef4444;cursor:pointer}
  .live{border-radius:12px;overflow:hidden;background:#000}
  #live{width:100%;height:auto;display:block}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn-s{padding:8px 10px;border-radius:10px;border:1px solid #cfd5e1;background:#fff;cursor:pointer;font-weight:700}
  .btn-s.primary{border:none;background:linear-gradient(180deg,var(--b1),var(--b2));color:#fff}
  .toast{position:fixed;right:16px;bottom:16px;background:#0e1626;color:#e8f0ff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.2);display:none}
</style>
</head>
<body>
<header class="top">
  <div class="topin">
    <a class="brand" href="listado.html"><img src="logo-baguet.png" alt=""><b style="color:#fff">BAGUET</b></a>
    <div></div>
    <div>
      <a class="btn" id="goList" href="listado.html">Listado</a>
      <a class="btn primary" href="publicar.html">Publicar</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="card"><div class="body">
    <h2 style="margin:0 0 10px">Crear publicaci√≥n</h2>

    <form id="postForm" autocomplete="off">
      <div class="row">
        <div><label>Sala</label><input id="room" type="text" placeholder="loja"></div>
        <div><label>Tu nombre</label><input id="author" type="text" required placeholder="Tu nombre"></div>
        <div><label>T√≠tulo / producto</label><input id="title" type="text" required placeholder="Ej. Pan artesanal"></div>
        <div><label>Precio (USD)</label><input id="price" type="number" step="0.01" min="0" required placeholder="1.50"></div>
        <div><label>WhatsApp</label><input id="phone" type="tel" placeholder="+593..."></div>
      </div>

      <div style="margin-top:10px">
        <label>Descripci√≥n</label>
        <textarea id="description" placeholder="Detalles, punto de entrega, etc."></textarea>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div class="box">
          <label>Subir fotos y videos (m√∫ltiples)</label>
          <input id="mediaInput" type="file" accept="image/*,video/*" multiple capture="environment" />
          <div class="muted" style="margin-top:6px">Las fotos se optimizan; los videos se env√≠an tal cual.</div>
          <div id="chips" class="chips"></div>
        </div>
        <div class="box">
          <label>C√°mara (foto / video)</label>
          <div class="live"><video id="live" autoplay playsinline muted></video></div>
          <div class="controls">
            <button type="button" class="btn-s" id="switchCam">Cambiar c√°mara</button>
            <button type="button" class="btn-s primary" id="takePhoto">Tomar foto</button>
            <button type="button" class="btn-s" id="startRec">Grabar video</button>
            <button type="button" class="btn-s" id="stopRec" disabled>Detener</button>
            <span class="muted" id="recHint">‚Äì</span>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:14px">
        <button id="btnPublish" class="btn primary" type="submit" disabled>Publicar</button>
        <span id="status" class="muted"></span>
      </div>
    </form>
  </div></div>
</main>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
<script>
/* ---- Config PocketBase ---- */
// Usa ?pb=http://TU-PB:8090 para sobreescribir, o localStorage.PB_URL
const urlPB = new URLSearchParams(location.search).get('pb') || localStorage.getItem('PB_URL') || 'http://127.0.0.1:8090';
localStorage.setItem('PB_URL', urlPB);
const pb = new PocketBase(urlPB);

/* ---- Refs ---- */
const $ = id => document.getElementById(id);
const statusEl=$('status'), btn=$('btnPublish'), chips=$('chips'), mediaInput=$('mediaInput');
const toast = msg => { const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); };
const params = new URLSearchParams(location.search);
const defaultRoom = params.get('sala') || 'loja';
$('room').value = defaultRoom;
$('goList').href = 'listado.html?sala=' + encodeURIComponent(defaultRoom);

/* ---- Adjuntos (con compresi√≥n de fotos) ---- */
let pending=[]; // File[]

mediaInput.addEventListener('change', ()=>{
  const files = Array.from(mediaInput.files||[]);
  files.forEach(f=>{
    if(f.type.startsWith('image/')){
      const r=new FileReader();
      r.onload=e=>{
        const img=new Image();
        img.onload=()=>{
          const maxW=1600, q=.82, s=Math.min(1,maxW/img.width);
          const w=Math.round(img.width*s), h=Math.round(img.height*s);
          const c=document.createElement('canvas'); c.width=w; c.height=h;
          c.getContext('2d').drawImage(img,0,0,w,h);
          c.toBlob(b=>{
            pending.push(new File([b],'foto_'+Date.now()+'.jpg',{type:'image/jpeg'}));
            renderChips();
          },'image/jpeg',q);
        };
        img.src=e.target.result;
      };
      r.readAsDataURL(f);
    }else{
      pending.push(f);
    }
  });
  mediaInput.value='';
  renderChips();
});
function renderChips(){
  const human=b=> b<1024? b+' B' : b<1048576? (b/1024).toFixed(1)+' KB' : (b/1048576).toFixed(1)+' MB';
  chips.innerHTML = pending.map((f,i)=>`<span class="chip">${f.type.startsWith('image/')?'üñºÔ∏è':'üé•'} ${f.name} <small style="color:#64748b">(${human(f.size)})</small> <button type="button" data-x="${i}">‚úï</button></span>`).join('');
}
chips.addEventListener('click',e=>{ const b=e.target.closest('[data-x]'); if(!b) return; pending.splice(+b.dataset.x,1); renderChips(); });

/* ---- C√°mara: foto y video ---- */
const live=$('live'), switchBtn=$('switchCam'), photoBtn=$('takePhoto'), recBtn=$('startRec'), stopBtn=$('stopRec'), recHint=$('recHint');
let stream=null, facing='environment', recorder=null, chunks=[], timer=null, t0=0;

async function startCam(){
  try{
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:facing, width:{ideal:1280}, height:{ideal:720} }, audio:true });
    live.srcObject = stream;
  }catch(e){ console.error(e); toast('Permiso de c√°mara denegado'); }
}
if('mediaDevices' in navigator) startCam();

switchBtn.addEventListener('click', async ()=>{ facing = (facing==='user')?'environment':'user'; await startCam(); });

photoBtn.addEventListener('click', ()=>{
  if(!stream) return;
  const track = stream.getVideoTracks()[0], s = track.getSettings();
  const w = s.width || 1280, h = s.height || 720;
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  c.getContext('2d').drawImage(live,0,0,w,h);
  c.toBlob(b=>{ pending.push(new File([b],'foto_'+Date.now()+'.jpg',{type:'image/jpeg'})); renderChips(); }, 'image/jpeg', .9);
});

recBtn.addEventListener('click', ()=>{
  if(!stream) return;
  chunks=[];
  try{ recorder = new MediaRecorder(stream, { mimeType:'video/webm;codecs=vp9,opus' }); }
  catch{ recorder = new MediaRecorder(stream); }
  recorder.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
  recorder.onstop = ()=>{
    const blob = new Blob(chunks, { type: recorder.mimeType || 'video/webm' });
    pending.push(new File([blob],'video_'+Date.now()+'.webm',{type:blob.type}));
    renderChips(); clearInterval(timer); recHint.textContent='‚Äì';
  };
  recorder.start();
  t0=Date.now(); timer=setInterval(()=>{ const s=Math.floor((Date.now()-t0)/1000); recHint.textContent=`Grabando ${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; },500);
  recBtn.disabled=true; stopBtn.disabled=false;
});
stopBtn.addEventListener('click', ()=>{ if(recorder && recorder.state!=='inactive') recorder.stop(); recBtn.disabled=false; stopBtn.disabled=true; });

/* ---- Auth invitado + habilitar bot√≥n ---- */
async function ensureGuest(){
  const K1='pb_u', K2='pb_p';
  let u=localStorage.getItem(K1), p=localStorage.getItem(K2);
  try{ if(u&&p){ await pb.collection('users').authWithPassword(u,p); return; } }catch{}
  u='guest_'+Math.random().toString(36).slice(2,10);
  p=Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);
  await pb.collection('users').create({username:u,password:p,passwordConfirm:p,name:u});
  await pb.collection('users').authWithPassword(u,p);
  localStorage.setItem(K1,u); localStorage.setItem(K2,p);
}
(async()=>{ try{ await ensureGuest(); btn.disabled=false; toast('Conectado a '+urlPB); }catch(e){ statusEl.textContent='Sin autenticaci√≥n (revisa PB_URL)'; } })();

/* ---- Publicar ---- */
$('postForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(btn.disabled) return;

  const me = pb.authStore.model;
  const room = ($('room').value||'loja').trim();
  const title = $('title').value.trim();
  const price = $('price').value;
  const author = $('author').value.trim() || (me?.username ?? 'An√≥nimo');
  const phone = $('phone').value.trim();
  const description = $('description').value.trim();

  if(!title || !price || !author){ statusEl.textContent='Completa t√≠tulo, precio y tu nombre.'; return; }

  const fd = new FormData();
  fd.append('room', room);
  fd.append('title', title);
  fd.append('price', price);
  fd.append('author', author);
  fd.append('phone', phone);
  fd.append('description', description);
  fd.append('user', me.id);

  const firstImg = pending.find(f=>f.type.startsWith('image/'));
  if(firstImg) fd.append('image', firstImg);
  pending.forEach(f => fd.append('media', f));

  const prev = btn.textContent; btn.disabled = true; btn.textContent='Publicando‚Ä¶'; statusEl.textContent='';
  try{
    await pb.collection('posts').create(fd);
    toast('Publicado ‚úì');
    location.href = 'listado.html?sala=' + encodeURIComponent(room);
  }catch(err){
    console.error(err);
    statusEl.textContent='Error al publicar';
    toast('Error al publicar');
    btn.disabled=false; btn.textContent=prev;
  }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Baguet ‚Äî Listado</title>
<link rel="icon" href="logo-baguet.png" />
<style>
  :root{--nav:#0e1626;--b1:#2563eb;--b2:#7c3aed;--border:#e7eaf1;--radius:14px;--muted:#64748b}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f6f7fb;color:#0f1720}
  .top{position:sticky;top:0;z-index:20;background:var(--nav);color:#e8f0ff;border-bottom:1px solid rgba(255,255,255,.08)}
  .topin{max-width:1100px;margin:auto;padding:10px 16px;display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}.brand img{width:36px;height:36px;border-radius:8px;background:#fff}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.25);background:transparent;color:#e8f0ff;border-radius:10px;padding:9px 12px;font-weight:700;text-decoration:none}
  .btn:hover{border-color:#fff}.primary{border:0;background:linear-gradient(180deg,var(--b1),var(--b2));color:#fff}
  .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
  .toolbar{display:flex;gap:10px;align-items:center;margin:10px 0}
  .search{flex:1;padding:10px 12px;border:1px solid #cfd5e1;border-radius:10px}
  .badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;padding:0 6px;font-size:12px;font-weight:700;border-radius:999px;color:#033;background:#d5efe9;border:1px solid #b6e0d6}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(3,minmax(0,1fr))}@media(max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}@media(max-width:640px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.05),0 6px 20px rgba(0,0,0,.06);overflow:hidden}
  .cover{width:100%;height:200px;object-fit:cover;display:block;border-bottom:1px solid var(--border)}
  .body{padding:14px}.muted{color:#64748b;font-size:13px}.price{font-weight:800;margin:6px 0}
  .strip{display:flex;gap:8px;overflow:auto;padding:8px;background:#fafafa;border-top:1px solid var(--border)}
  .strip img,.strip video{width:160px;height:120px;object-fit:cover;border-radius:10px;border:1px solid #e1e4ea;background:#f1f3f7}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .link{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px;border:1px solid #c9cccf;background:#fff;text-decoration:none;color:#111;font-weight:700}
</style>
</head>
<body>
<header class="top">
  <div class="topin">
    <a class="brand" href="listado.html"><img src="logo-baguet.png" alt=""><b style="color:#fff">BAGUET</b></a>
    <div></div>
    <div>
      <a class="btn" id="toRoom" href="#">Sala: ‚Ä¶</a>
      <a class="btn primary" id="toPublish" href="publicar.html">Publicar</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="toolbar">
    <input id="q" class="search" type="search" placeholder="Buscar por t√≠tulo o autor‚Ä¶">
    <span id="count" class="badge">0</span>
  </div>
  <section id="feed" class="grid"></section>
</main>

<script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
<script>
const urlPB = localStorage.getItem('PB_URL') || 'http://127.0.0.1:8090';
const pb = new PocketBase(urlPB);
const $ = id => document.getElementById(id);

const params = new URLSearchParams(location.search);
const room = params.get('sala') || 'loja';
$('toRoom').textContent = 'Sala: ' + room;
$('toRoom').href = 'listado.html?sala=' + encodeURIComponent(room);
$('toPublish').href = 'publicar.html?sala=' + encodeURIComponent(room);

async function ensureGuest(){
  const K1='pb_u', K2='pb_p';
  let u=localStorage.getItem(K1), p=localStorage.getItem(K2);
  try{ if(u&&p){ await pb.collection('users').authWithPassword(u,p); return; } }catch{}
  u='guest_'+Math.random().toString(36).slice(2,10);
  p=Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);
  await pb.collection('users').create({username:u,password:p,passwordConfirm:p,name:u});
  await pb.collection('users').authWithPassword(u,p);
  localStorage.setItem(K1,u); localStorage.setItem(K2,p);
}

const feed=$('feed'), countEl=$('count'), q=$('q');
const posts=new Map();
const isVideo=n=>/\.(mp4|mov|webm|m4v|avi)$/i.test(n||'');
const esc=s=>(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
function render(){
  feed.innerHTML='';
  const term=(q.value||'').toLowerCase().trim();
  const arr=[...posts.values()]
    .filter(r=>!term || (r.title||'').toLowerCase().includes(term) || (r.author||'').toLowerCase().includes(term))
    .sort((a,b)=>new Date(b.created)-new Date(a.created));
  arr.forEach(r=>{
    const card=document.createElement('article'); card.className='card';
    if(r.image){ const url=pb.files.getUrl(r,r.image,{thumb:'900x0'}); const img=document.createElement('img'); img.className='cover'; img.src=url; img.alt=r.title; card.appendChild(img); }
    if(Array.isArray(r.media)&&r.media.length){
      const strip=document.createElement('div'); strip.className='strip';
      r.media.forEach(name=>{
        const url=pb.files.getUrl(r,name);
        if(isVideo(name)){ const v=document.createElement('video'); v.src=url; v.controls=true; v.playsInline=true; strip.appendChild(v); }
        else{ const i=document.createElement('img'); i.src=url; i.alt=name; strip.appendChild(i); }
      }); card.appendChild(strip);
    }
    const body=document.createElement('div'); body.className='body';
    body.innerHTML=`<h3 style="margin:0 0 6px">${esc(r.title)}</h3>
      <div class="muted">Por ${esc(r.author||'An√≥nimo')} ‚Ä¢ ${new Date(r.created).toLocaleString()}</div>
      <div class="price">$${Number(r.price||0).toFixed(2)}</div>
      ${r.description?`<p class="muted" style="margin:6px 0 0">${esc(r.description)}</p>`:''}`;
    const tel=(r.phone||'').replace(/[^0-9+]/g,''); const row=document.createElement('div'); row.className='row';
    if(tel){ const wa=document.createElement('a'); wa.className='link'; wa.target='_blank'; wa.href=`https://wa.me/${tel}?text=${encodeURIComponent('Hola, me interesa: '+r.title)}`; wa.textContent='WhatsApp';
             const call=document.createElement('a'); call.className='link'; call.href=`tel:${tel}`; call.textContent='Llamar';
             row.appendChild(wa); row.appendChild(call); }
    body.appendChild(row); card.appendChild(body); feed.appendChild(card);
  });
  countEl.textContent = arr.length;
}
q.addEventListener('input', render);

async function load(){
  const list=await pb.collection('posts').getFullList({sort:'-created', filter:`room="${room}"`});
  posts.clear(); list.forEach(r=>posts.set(r.id,r)); render();
  if(window._unsub) await window._unsub;
  window._unsub = await pb.collection('posts').subscribe(`room="${room}"`, e=>{
    const r=e.record; if(e.action==='create'||e.action==='update') posts.set(r.id,r); if(e.action==='delete') posts.delete(r.id); render();
  });
}
(async()=>{ await ensureGuest(); await load(); })();
</script>
</body>
</html>
