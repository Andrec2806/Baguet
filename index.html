<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Baguet Loja — Red social local</title>
<meta name="description" content="Baguet: publica y vende productos locales; salas compartidas por enlace y presencia en vivo.">
<style>
  :root{
    --nav-bg:#0c1320; --brand-1:#6d28d9; --brand-2:#2563eb; --accent:#10b981;
    --ink:#0f1720; --muted:#6b7280; --bg:#f5f7fb; --surface:#fff; --radius:14px;
    --shadow:0 1px 2px rgba(0,0,0,.05), 0 6px 20px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
  /* NAV */
  .nav{position:sticky;top:0;z-index:40;background:var(--nav-bg);color:#e5eef7;border-bottom:1px solid rgba(255,255,255,.06)}
  .nav-inner{max-width:1120px;margin:auto;padding:14px 16px;display:grid;grid-template-columns:auto 1fr auto;gap:16px;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}
  .brand img{width:36px;height:36px;border-radius:8px;object-fit:cover;background:#fff}
  .brand b{display:block;font-size:16px}
  .brand span{font-size:11px;opacity:.85;letter-spacing:1px}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;color:#e5eef7;border:1px solid rgba(255,255,255,.2)}
  .btn-ghost:hover{border-color:#fff}
  .btn-primary{background:linear-gradient(180deg,var(--brand-2),var(--brand-1));color:#fff;box-shadow:var(--shadow)}
  /* LAYOUT */
  .container{max-width:1120px;margin:26px auto;padding:0 16px}
  .surface{background:#fff;border:1px solid #e8ebf3;border-radius:var(--radius);box-shadow:var(--shadow)}
  h1,h2{margin:0 0 12px}
  /* PRESENCIA */
  .room-bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:14px}
  .room-id{font-size:14px;color:#334155}
  .presence{display:flex;flex-wrap:wrap;gap:8px}
  .avatar{width:36px;height:36px;border-radius:999px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
  .avatar[data-me="1"]{outline:2px solid var(--accent)}
  .pill{padding:4px 10px;border-radius:999px;background:#eef5ff;border:1px solid #d7e7ff;color:#334155;font-size:12px;font-weight:700}
  /* FORM */
  form.surface{padding:18px;margin-bottom:18px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:720px){.grid-2{grid-template-columns:1fr}}
  label{display:block;font-size:13px;color:#475569;margin:2px 0 6px}
  input[type="text"],input[type="number"],input[type="tel"],textarea{
    width:100%;padding:12px;border:1px solid #cfd5e1;border-radius:10px;font-size:14px;background:#fff
  }
  input:focus,textarea:focus{outline:none;border-color:#9ac5ff;box-shadow:0 0 0 3px rgba(37,99,235,.16)}
  textarea{resize:vertical;min-height:84px}
  .file-row{display:grid;grid-template-columns:1fr 180px;gap:14px;align-items:center}
  @media (max-width:720px){.file-row{grid-template-columns:1fr}}
  .preview{width:100%;height:170px;border:1px dashed #cfd5e1;border-radius:10px;background:#f8fafc;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:12px;overflow:hidden}
  .preview img{width:100%;height:100%;object-fit:cover;display:none}
  /* FEED */
  .list-header{display:flex;align-items:center;gap:8px;margin:22px 0 12px}
  .badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;padding:0 6px;font-size:12px;font-weight:700;border-radius:999px;color:#033;background:#d5efe9;border:1px solid #b6e0d6}
  .grid-cards{display:grid;gap:16px;grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:980px){.grid-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:640px){.grid-cards{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid #e8ebf3;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .card img{width:100%;height:180px;object-fit:cover;display:block}
  .card .body{padding:14px}
  .card h3{margin:0 0 6px 0;font-size:16px}
  .muted{color:var(--muted);font-size:13px}
  .price{font-weight:800;margin:6px 0}
  .cta{display:flex;gap:8px;margin-top:10px}
  .link{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px;border:1px solid #c9cccf;background:#fff;text-decoration:none;color:#111;font-weight:700;font-size:13px}
</style>
</head>
<body>

<!-- NAV -->
<div class="nav">
  <div class="nav-inner">
    <div class="brand">
      <img src="logo-baguet.png" alt="Baguet Loja">
      <div><b>BAGUET</b><span>LOJA</span></div>
    </div>
    <div></div>
    <div>
      <button class="btn btn-ghost" id="copyLinkBtn">Copiar link de sala</button>
      <a class="btn btn-primary" href="#publicar">Publicar</a>
    </div>
  </div>
</div>

<main class="container">
  <!-- Sala / Presencia -->
  <div class="room-bar">
    <div class="room-id">Sala: <strong id="roomName">—</strong> · <span class="pill" id="onlineCount">0 en línea</span></div>
    <div class="presence" id="presence"></div>
  </div>

  <!-- Form publicar -->
  <form id="productForm" class="surface" autocomplete="off">
    <div class="grid-2">
      <div>
        <label>Nombre del producto</label>
        <input id="nombreProducto" type="text" required placeholder="Ej. Pan artesanal" />
      </div>
      <div>
        <label>Precio (USD)</label>
        <input id="precioProducto" type="number" step="0.01" min="0" required placeholder="Ej. 1.50" />
      </div>
      <div>
        <label>Tu nombre (se mostrará en la sala)</label>
        <input id="nombreVendedor" type="text" required placeholder="Tu nombre" />
      </div>
      <div>
        <label>Teléfono (WhatsApp)</label>
        <input id="telefono" type="tel" placeholder="+593..." />
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Descripción</label>
      <textarea id="descripcionProducto" rows="3" placeholder="Horario, punto de entrega, si aceptas trueque, etc."></textarea>
    </div>

    <div class="file-row" style="margin-top:10px">
      <div>
        <label>Imagen (opcional)</label>
        <input id="imagen" type="file" accept="image/*" />
        <div class="muted" style="margin-top:6px">Se comparte en la sala (comprimida para ahorrar datos).</div>
      </div>
      <div class="preview" id="previewBox">
        <span>Vista previa</span>
        <img id="previewImg" alt="Vista previa"/>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="btn btn-primary" type="submit">Publicar</button>
      <span class="muted" id="status"></span>
    </div>
  </form>

  <!-- Feed -->
  <div class="list-header">
    <h2 id="listado" style="margin:0">Publicaciones de la sala</h2>
    <span class="badge" id="count">0</span>
  </div>
  <section id="productos" class="grid-cards"></section>
</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  /* ====== CONFIGURA TU FIREBASE AQUÍ ====== */
  const FIREBASE_CONFIG = {
    apiKey: "PASTE_API_KEY",
    authDomain: "PASTE_AUTH_DOMAIN",
    databaseURL: "PASTE_DATABASE_URL",
    projectId: "PASTE_PROJECT_ID",
    storageBucket: "PASTE_STORAGE_BUCKET",
    messagingSenderId: "PASTE_SENDER_ID",
    appId: "PASTE_APP_ID"
  };
  const USE_FIREBASE = FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.apiKey !== "PASTE_API_KEY";

  // Sala desde ?sala=xxx (por defecto 'publico')
  const params = new URLSearchParams(location.search);
  const roomId = params.get('sala') || 'publico';
  document.getElementById('roomName').textContent = roomId;

  // Nombre guardado
  const nameInput = document.getElementById('nombreVendedor');
  const savedName = localStorage.getItem('baguet_name') || '';
  if (savedName) nameInput.value = savedName;
  nameInput.addEventListener('input', ()=> localStorage.setItem('baguet_name', nameInput.value.trim()));

  // Copiar link de sala
  document.getElementById('copyLinkBtn').addEventListener('click', async ()=>{
    const link = location.origin + location.pathname + '?sala=' + encodeURIComponent(roomId);
    await navigator.clipboard.writeText(link);
    alert('Link copiado: ' + link);
  });

  // Estado local (para funcionar offline también)
  const LS_KEY = "baguet_social_" + roomId;
  const form = document.getElementById("productForm");
  const statusEl = document.getElementById("status");
  const grid = document.getElementById("productos");
  const countEl = document.getElementById("count");
  const fileInput = document.getElementById("imagen");
  const previewBox = document.getElementById("previewBox");
  const previewImg = document.getElementById("previewImg");
  const presenceBox = document.getElementById("presence");
  const onlineCount = document.getElementById("onlineCount");
  let imageDataURL = "";

  function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return []; } }
  function saveLocal(item){ const data=loadLocal(); data.unshift(item); localStorage.setItem(LS_KEY, JSON.stringify(data)); return data; }

  function avatarColor(seed){ let h=0; for (let i=0;i<seed.length;i++) h=(h*31 + seed.charCodeAt(i))%360; return `hsl(${h} 70% 45%)`; }

  function renderPresence(list, meName){
    presenceBox.innerHTML = "";
    const arr = list && list.length ? list : (meName ? [{name:meName}] : []);
    arr.forEach(u=>{
      const av=document.createElement('div');
      av.className='avatar';
      av.textContent=(u.name||'¿?').trim().charAt(0).toUpperCase();
      av.title=u.name||'Anónimo';
      av.style.background=avatarColor(u.name||'x');
      if (u.isMe) av.dataset.me="1";
      presenceBox.appendChild(av);
    });
    onlineCount.textContent = `${arr.length} en línea`;
  }

  function render(list){
    grid.innerHTML=""; countEl.textContent=list.length;
    list.forEach(p=>{
      const tel=(p.telefono||"").replace(/[^0-9+]/g,'');
      const wsp= tel ? `https://wa.me/${tel}?text=${encodeURIComponent("Hola, me interesa tu producto: "+p.producto)}` : null;
      const el=document.createElement("article");
      el.className="card";
      el.innerHTML = `
        ${p.image ? `<img src="${p.image}" alt="${p.producto}">` : ""}
        <div class="body">
          <h3>${p.producto}</h3>
          <div class="muted">Publicado por: ${p.vendedor || "Anónimo"}</div>
          <div class="price">$${Number(p.precio).toFixed(2)}</div>
          ${p.descripcion ? `<p class="muted" style="margin:6px 0 0">${p.descripcion}</p>` : ""}
          <div class="cta">
            ${wsp ? `<a class="link" target="_blank" href="${wsp}">WhatsApp</a>` : ""}
            ${tel ? `<a class="link" href="tel:${tel}">Llamar</a>` : ""}
          </div>
        </div>`;
      grid.appendChild(el);
    });
  }

  // Carga inicial local
  render(loadLocal());
  renderPresence([], nameInput.value.trim() || "Invitado");

  // Vista previa + compresión simple
  fileInput.addEventListener("change", ()=>{
    const file=fileInput.files?.[0];
    if(!file){ imageDataURL=""; previewImg.style.display="none"; previewBox.firstElementChild.style.display=""; return; }
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const maxW=1000, q=0.8;
        const s=Math.min(1, maxW/img.width);
        const w=Math.round(img.width*s), h=Math.round(img.height*s);
        const canvas=document.createElement('canvas');
        canvas.width=w; canvas.height=h;
        const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        imageDataURL=canvas.toDataURL('image/jpeg', q);
        previewImg.src=imageDataURL; previewImg.style.display="block"; previewBox.firstElementChild.style.display="none";
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  });

  // ======== Firebase en tiempo real (social) ========
  let db=null, auth=null, uid=null, myPresenceRef=null;
  if (USE_FIREBASE) {
    firebase.initializeApp(FIREBASE_CONFIG);
    auth = firebase.auth();
    db = firebase.database();

    auth.signInAnonymously().catch(console.error);
    auth.onAuthStateChanged(user=>{
      if (!user) return;
      uid = user.uid;

      // PRESENCE
      const meName = nameInput.value.trim() || "Invitado";
      const presRef = db.ref(`rooms/${roomId}/presence`);
      myPresenceRef = presRef.child(uid);
      firebase.database().ref(".info/connected").on("value", snap=>{
        if (snap.val() === true) {
          myPresenceRef.onDisconnect().remove();
          myPresenceRef.set({ name: meName, ts: firebase.database.ServerValue.TIMESTAMP });
        }
      });
      // Update name live
      nameInput.addEventListener('input', ()=>{
        const nm = nameInput.value.trim() || "Invitado";
        localStorage.setItem('baguet_name', nm);
        if (myPresenceRef) myPresenceRef.set({ name:nm, ts: firebase.database.ServerValue.TIMESTAMP });
      });

      // Escuchar presencia
      presRef.on("value", snap=>{
        const val = snap.val() || {};
        const arr = Object.keys(val).map(k => ({...val[k], isMe: k===uid}));
        renderPresence(arr, meName);
      });

      // FEED: escuchar últimos 200
      const postsRef = db.ref(`rooms/${roomId}/posts`).limitToLast(200);
      const remote = [];
      postsRef.on("child_added", s=>{
        const item=s.val(); remote.unshift(item);
        // Combinar con local
        const local = loadLocal();
        const key = p => [p.producto,p.vendedor,p.precio,p.ts].join("|");
        const map = new Map([...remote, ...local].map(x => [key(x), x]));
        const arr = Array.from(map.values()).sort((a,b)=>b.ts-a.ts);
        render(arr); countEl.textContent = arr.length;
      });
    });
  }

  // Publicar (local + remoto)
  form.addEventListener("submit",(e)=>{
    e.preventDefault();
    const pub={
      producto:document.getElementById("nombreProducto").value.trim(),
      precio:document.getElementById("precioProducto").value.trim(),
      vendedor:nameInput.value.trim() || "Anónimo",
      telefono:document.getElementById("telefono").value.trim(),
      descripcion:document.getElementById("descripcionProducto").value.trim(),
      image:imageDataURL,
      ts: Date.now()
    };
    if(!pub.producto || !pub.precio || !pub.vendedor){
      statusEl.textContent="Completa producto, precio y vendedor."; return;
    }
    // Local
    const list=saveLocal(pub); render(list);
    statusEl.textContent="Publicado.";

    // Remoto
    if (db){ db.ref(`rooms/${roomId}/posts`).push(pub); }

    form.reset(); imageDataURL=""; previewImg.style.display="none"; previewBox.firstElementChild.style.display="";
  });

  // Mostrar cuántos hay aunque no uses Firebase (tu “yo” local)
  if (!USE_FIREBASE) {
    renderPresence([{name: nameInput.value.trim() || "Invitado", isMe:true}], nameInput.value.trim() || "Invitado");
  }
</script>
</body>
</html>
