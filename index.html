<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Baguet – Capturar fotos y videos</title>
<style>
  :root{
    --nav:#0c1320; --brand1:#2563eb; --brand2:#6d28d9;
    --bg:#f5f7fb; --ink:#0f1720; --muted:#6b7280;
    --radius:14px; --shadow:0 1px 2px rgba(0,0,0,.05), 0 6px 20px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
  .nav{position:sticky;top:0;z-index:10;background:var(--nav);color:#e5eef7;border-bottom:1px solid rgba(255,255,255,.08)}
  .nav-inner{max-width:1100px;margin:auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .nav img{width:40px;height:40px;border-radius:10px;background:#fff;object-fit:cover}
  .brand{line-height:1}
  .brand b{display:block;letter-spacing:.3px}
  .brand small{opacity:.8}
  .container{max-width:1100px;margin:22px auto;padding:0 16px}
  .surface{background:#fff;border:1px solid #e7eaf1;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  label{font-size:13px;color:#475569;margin-bottom:6px;display:block}
  input[type="text"], input[type="number"], input[type="file"]{width:100%;padding:10px;border:1px solid #cfd5e1;border-radius:10px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{appearance:none;border:1px solid #cfd5e1;background:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-primary{border:none;background:linear-gradient(180deg,var(--brand1),var(--brand2));color:#fff}
  .hint{font-size:12px;color:var(--muted)}
  .video-wrap{position:relative;background:#000;border-radius:12px;overflow:hidden}
  video#live{width:100%;height:auto;display:block}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .gallery{display:grid;gap:14px;grid-template-columns:repeat(3,minmax(0,1fr));margin-top:16px}
  @media (max-width:1000px){ .gallery{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:640px){ .gallery{grid-template-columns:1fr} }
  .card{background:#fff;border:1px solid #e7eaf1;border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
  .thumb{width:100%;height:220px;object-fit:cover;background:#f1f3f7;display:block}
  .card .body{padding:10px}
  .meta{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#eef5ff;border:1px solid #d7e7ff;font-size:12px;font-weight:700;color:#344}
</style>
</head>
<body>

<!-- NAV -->
<header class="nav">
  <div class="nav-inner">
    <img src="logo-baguet.png" alt="Baguet Loja" />
    <div class="brand"><b>BAGUET</b><small>LOJA</small></div>
  </div>
</header>

<main class="container">

  <!-- Cargar archivos -->
  <section class="surface">
    <div class="grid">
      <div>
        <label>Subir fotos o videos (múltiples)</label>
        <input id="picker" type="file" accept="image/*,video/*" multiple />
        <div class="hint">Consejo: en móviles puedes abrir la cámara desde aquí si tu navegador lo permite.</div>
      </div>

      <div>
        <label>Cámara (foto y video)</label>
        <div class="video-wrap">
          <video id="live" playsinline autoplay muted></video>
        </div>
        <div class="controls">
          <button class="btn" id="toggleFacing">Cambiar cámara (frontal/trasera)</button>
          <button class="btn" id="takePhoto">Tomar foto</button>
          <button class="btn" id="startRec">Grabar video</button>
          <button class="btn" id="stopRec" disabled>Detener</button>
          <span class="hint" id="recHint">–</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Galería -->
  <section class="surface">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:4px 0">Galería</h3>
      <span class="tag"><span id="count">0</span>&nbsp; ítems</span>
    </div>
    <div id="gallery" class="gallery"></div>
  </section>

</main>

<!-- Lógica -->
<script>
(() => {
  /*** Estado ***/
  const picker = document.getElementById('picker');
  const gallery = document.getElementById('gallery');
  const countEl = document.getElementById('count');
  const live = document.getElementById('live');
  const toggleFacingBtn = document.getElementById('toggleFacing');
  const takePhotoBtn = document.getElementById('takePhoto');
  const startRecBtn = document.getElementById('startRec');
  const stopRecBtn = document.getElementById('stopRec');
  const recHint = document.getElementById('recHint');

  let items = []; // {type:'image'|'video', blob, url, name, size, created}
  let stream = null;
  let facingMode = 'environment'; // 'user' o 'environment'
  let mediaRecorder = null;
  let recChunks = [];
  let recTimer = null;
  let recStartAt = 0;

  /*** Helpers ***/
  const pad = n => String(n).padStart(2,'0');
  const tsName = (prefix, ext) => {
    const d = new Date();
    const name = `${prefix}_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}.${ext}`;
    return name;
  };
  const humanSize = b => {
    if (b<1024) return b+' B';
    if (b<1024*1024) return (b/1024).toFixed(1)+' KB';
    return (b/(1024*1024)).toFixed(1)+' MB';
  };
  const resetTimer = () => { clearInterval(recTimer); recTimer=null; recHint.textContent='–'; };

  /*** Cámara ***/
  async function startCamera() {
    try {
      if (stream) stream.getTracks().forEach(t => t.stop());
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode, width: {ideal: 1280}, height: {ideal: 720} },
        audio: true
      });
      live.srcObject = stream;
    } catch (err) {
      console.error(err);
      alert('No se pudo acceder a la cámara/micrófono. Revisa permisos del navegador.');
    }
  }

  toggleFacingBtn.addEventListener('click', async () => {
    facingMode = (facingMode === 'user') ? 'environment' : 'user';
    await startCamera();
  });

  // Foto desde el stream (canvas)
  takePhotoBtn.addEventListener('click', () => {
    if (!stream) return;
    const track = stream.getVideoTracks()[0];
    const settings = track.getSettings();
    const w = settings.width || 1280;
    const h = settings.height || 720;

    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(live, 0, 0, w, h);
    canvas.toBlob((blob) => {
      const url = URL.createObjectURL(blob);
      addItem({ type:'image', blob, url, name: tsName('foto','jpg'), size: blob.size });
    }, 'image/jpeg', 0.9);
  });

  // Grabar video
  startRecBtn.addEventListener('click', () => {
    if (!stream) return;
    recChunks = [];
    try{
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9,opus' });
    }catch{
      mediaRecorder = new MediaRecorder(stream); // fallback
    }
    mediaRecorder.ondataavailable = (e)=>{ if (e.data.size>0) recChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recChunks, { type: mediaRecorder.mimeType || 'video/webm' });
      const url = URL.createObjectURL(blob);
      addItem({ type:'video', blob, url, name: tsName('video', blob.type.includes('mp4')?'mp4':'webm'), size: blob.size });
      resetTimer();
    };
    mediaRecorder.start();
    recStartAt = Date.now();
    recTimer = setInterval(()=>{
      const s = Math.floor((Date.now()-recStartAt)/1000);
      const mm = pad(Math.floor(s/60)), ss = pad(s%60);
      recHint.textContent = `Grabando ${mm}:${ss}`;
    }, 500);
    startRecBtn.disabled = true;
    stopRecBtn.disabled = false;
  });

  stopRecBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
    }
    startRecBtn.disabled = false;
    stopRecBtn.disabled = true;
  });

  /*** Cargar archivos del dispositivo ***/
  picker.addEventListener('change', async () => {
    const files = Array.from(picker.files || []);
    for (const f of files) {
      if (f.type.startsWith('image/')) {
        // Mostrar directo; si quieres comprimir, podrías pasar por canvas
        const url = URL.createObjectURL(f);
        addItem({ type:'image', blob:f, url, name: f.name, size:f.size });
      } else if (f.type.startsWith('video/')) {
        const url = URL.createObjectURL(f);
        addItem({ type:'video', blob:f, url, name: f.name, size:f.size });
      }
    }
    picker.value = '';
  });

  /*** Galería ***/
  function addItem(obj){
    items.unshift({ ...obj, created: new Date() });
    render();
  }

  function render(){
    gallery.innerHTML = '';
    items.forEach((it, idx) => {
      const card = document.createElement('article');
      card.className = 'card';

      if (it.type === 'image') {
        const img = document.createElement('img');
        img.className = 'thumb';
        img.src = it.url;
        img.alt = it.name;
        card.appendChild(img);
      } else {
        // mini reproductor
        const v = document.createElement('video');
        v.className = 'thumb';
        v.src = it.url;
        v.controls = true;
        v.playsInline = true;
        card.appendChild(v);
      }

      const body = document.createElement('div');
      body.className = 'body';
      body.innerHTML = `
        <div class="meta">${it.type.toUpperCase()} • ${it.name}</div>
        <div class="meta">Tamaño: ${humanSize(it.size)} • ${it.created.toLocaleString()}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'actions';
      const a = document.createElement('a');
      a.className = 'btn';
      a.download = it.name;
      a.href = it.url;
      a.textContent = 'Descargar';
      actions.appendChild(a);

      const del = document.createElement('button');
      del.className = 'btn';
      del.textContent = 'Eliminar';
      del.addEventListener('click', () => {
        URL.revokeObjectURL(it.url);
        items.splice(idx,1);
        render();
      });
      actions.appendChild(del);

      body.appendChild(actions);
      card.appendChild(body);
      gallery.appendChild(card);
    });
    countEl.textContent = items.length;
  }

  /*** Inicio ***/
  if ('mediaDevices' in navigator) startCamera();
  else alert('Tu navegador no soporta cámara (getUserMedia).');

})();
</script>
</body>
</html>
